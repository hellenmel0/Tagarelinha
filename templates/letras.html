<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tagarelinha: Aprenda brincando com letras e desenhos!">
    <meta name="keywords" content="Educa√ß√£o, Aprendizagem, Letras, Desenho, Tagarelinha">
    <link rel="stylesheet" href="{{ url_for('static', filename='main3.css') }}">
    <title>LETRAS - TAGARELINHA</title>
</head>

<body>
    <!-- Cabe√ßalho da p√°gina -->
    <header>
        <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"
                class="logo"></a>
        <nav>
            <ul>
                <!-- Links para outras p√°ginas do sistema -->
                <li><a href="{{ url_for('principal') }}">In√≠cio</a></li>
                <li><a href="{{ url_for('fala') }}">Falar √© f√°cil</a></li>
                <li><a href="{{ url_for('letras') }}">Letras</a></li>
            </ul>
        </nav>

        <!-- Link da p√°gina de perfil para futuras aplica√ß√µes-->
        <div class="user-icon">
            <a href="{{ url_for('perfil') }}">
                <img src="{{ url_for('static', filename='perfil.png') }}" id="perfil" alt="Usu√°rio">
            </a>
        </div>
    </header>

    <!-- Conte√∫do principal -->
    <main>
        <!-- Op√ß√£o para escolher a letra que o usu√°rio deseja revisar-->
        <center>
            <h1>ESCOLHA UMA LETRA</h1>
        </center>

        <section class="letter-grid" id="letterGrid">
            <!-- Gera automaticamente todas as letras -->
        </section>

        <!-- Conteiner para desenhar -->
        <div class="card">
            <!-- Canvas onde o usu√°rio pode desenhar -->
            <div class="box-aluno">
                <div class="topo">
                    <!-- Bot√£o com a fun√ß√£o de salvar imagem -->
                    <button id="saveButton">Salvar<br><img class="save"
                            src="{{ url_for('static', filename='save.png') }}" alt="Salvar"></button>

                    <h2>Aluno</h2>

                    <!-- Bot√£o com a fun√ß√£o de limpar o canvas -->
                    <button id="clearButton">Apagar<br><img class="clear"
                            src="{{ url_for('static', filename='erase.png') }}" alt="APAGAR"></button>
                </div>
                <!-- Canvas onde √© possivel realizar o desenho -->
                <canvas id="drawingCanvas" width="500" height="250"></canvas>
            </div>


            <!-- Box do sistema, aparecer√° a letra escolhida pelo usu√°rio -->
            <div class="box-imagem">
                <div class="topo2">
                    <!-- Bot√£o com a fun√ß√£o de ouvir a letra escolhida -->
                    <button id="listenButton">Ou√ßa<br><img class="listen"
                            src="{{ url_for('static', filename='falante.png') }}" alt="Ouvir"></button>

                    <h2>Letra Escolhida</h2>

                    <!-- Bot√£o com a fun√ß√£o de limpar o canvas -->
                    <button id="clearChosenLetterButton">Apagar<br><img class="clear"
                            src="{{ url_for('static', filename='erase.png') }}" alt="APAGAR"></button>
                </div>
                <center>
                    <!-- Letra escolhida -->
                    <h3 id="chosenLetter"></h3>
                </center>
            </div>
        </div>

        <center>
            <!-- Bot√£o de enviar a imagem para a analise da IA -->
            <button id="predictButton">ENVIAR</button>
            <br><br>

            <!-- Retorno da IA -->
            <div class="feedback" id="feedbackIcon"></div>
        </center>
    </main>

    <!-- Rodap√© -->
    <footer>
        <p>&copy; Copyright 2024 - Tagarelinha</p>
    </footer>

    <!-- Script com as fun√ß√µes utilizadas -->
    <script>
        // Vari√°veis 
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');                    // Lista (array) com letras do alfabeto 
        const letterGrid = document.getElementById('letterGrid');                   // Refr√™ncia ao grid no html com ID letterGrid
        const chosenLetterElem = document.getElementById('chosenLetter');           // Refer√™ncia ao elemento que mostra a letra selecionada.
        const canvas = document.getElementById('drawingCanvas');                    // Refer√™ncia ao elemento canvas para desenha
        const context = canvas.getContext('2d');                                    //Dimens√µes do elemento canvas, para a manipula√ß√£o gr√°fica

        //Refer√™ncias aos bot√µes 'Apagar', 'Enviar', 'Ou√ßa' e ao √≠cone de feedback 
        const clearButton = document.getElementById('clearButton');
        const predictButton = document.getElementById('predictButton');
        const feedbackIcon = document.getElementById('feedbackIcon');
        const listenButton = document.getElementById('listenButton');
        const clearChosenLetterButton = document.getElementById('clearChosenLetterButton');

        let chosenLetter = '';

        // Para cada letra do alfabeto, cria um elemento de letra e configura um evento de clique
        alphabet.forEach(letter => {
            const letterElem = document.createElement('div');                       // Cria um elemento 'div' para representar a letra
            letterElem.textContent = letter;                                        // Define o texto do elemento como a letra atual
            letterElem.classList.add('letter');                                     // Adiciona uma classe 'letter' para estiliza√ß√£o
            letterElem.addEventListener('click', () => {                            // Adiciona um evento de clique na letra
                chosenLetter = letter;                                              // Define a letra escolhida
                chosenLetterElem.textContent = letter;                              // Exibe a letra escolhida na interface
                context.clearRect(0, 0, canvas.width, canvas.height);               // Limpa o desenho ao escolher nova letra
                feedbackIcon.textContent = '';                                      // Limpa o feedback de resposta ao mudar de letra
                clearFeedback();                                                    // Chama a fun√ß√£o para limpar o feedback
            });
            letterGrid.appendChild(letterElem);                                     // Adiciona o elemento da letra ao grid de letras
        });

        // Fun√ß√£o para s√≠ntese de fala
        function speakLetter(letter) {
            const synth = window.speechSynthesis;                                   // Objeto de s√≠ntese de fala do navegador
            const utterance = new SpeechSynthesisUtterance(letter);                 // Cria uma fala com a letra
            utterance.lang = 'pt-BR';                                               // Define o idioma como portugu√™s do Brasil
            synth.speak(utterance);                                                 // Executa a fala
        }

        // Evento para o bot√£o "Ou√ßa"
        listenButton.addEventListener('click', () => {
            if (chosenLetter) {
                speakLetter(chosenLetter);                                          // Fala a letra escolhida
            } else {
                alert('Escolha uma letra primeiro!');                               // Alerta se nenhuma letra foi escolhida
            }
        });

        // L√≥gica para desenho no canvas
        let drawing = false;                                                        // Estado para indicar se o usu√°rio est√° desenhando
        context.lineWidth = 15;                                                     // Define a largura da linha
        context.lineCap = 'round';                                                  // Define a forma da ponta da linha
        context.strokeStyle = '#0B3A40';                                            // Define a cor da linha

        canvas.addEventListener('mousedown', (event) => {                           // Inicia o desenho ao pressionar o mouse
            drawing = true;                                                         // Ativa o estado de desenho
            const rect = canvas.getBoundingClientRect();                            // Pega as coordenadas do canvas
            context.beginPath();                                                    // Inicia um novo caminho de desenho
            context.moveTo(event.clientX - rect.left, event.clientY - rect.top);    // Move para o ponto inicial
        });

        canvas.addEventListener('mousemove', (event) => {                           // Desenha enquanto o mouse se move
            if (drawing) {                                                          // Verifica se o desenho est√° ativado
                const rect = canvas.getBoundingClientRect();
                context.lineTo(event.clientX - rect.left, event.clientY - rect.top);// Cria uma linha at√© o ponto atual
                context.stroke();                                                   // Desenha a linha
            }
        });

        canvas.addEventListener('mouseup', () => {                                  // Finaliza o desenho ao soltar o mouse
            drawing = false;                                                        // Desativa o estado de desenho
        });

        // Fun√ß√£o para limpar o feedback e a letra escolhida
        function clearFeedback() {
            feedbackIcon.textContent = '';                                          // Limpa o feedback
        }

        // Limpa o canvas
        clearButton.addEventListener('click', () => {
            context.clearRect(0, 0, canvas.width, canvas.height);                   // Limpa todo o conte√∫do do canvas
            feedbackIcon.textContent = '';                                          // Limpa o feedback
        });

        // Limpa a letra escolhida
        clearChosenLetterButton.addEventListener('click', () => {
            chosenLetter = '';                                                      // Reseta a letra escolhida
            chosenLetterElem.textContent = '';                                      // Limpa o elemento de letra escolhida na interface
            feedbackIcon.textContent = '';                                          // Limpa o feedback
        });

        // Envia a imagem desenhada para o servidor
        predictButton.addEventListener('click', () => {
            if (!chosenLetter) {                                                    // Verifica se uma letra foi escolhida
                alert('Escolha uma letra primeiro!');                               // Alerta caso n√£o tenha uma letra selecionada
                return;
            }

            // Cria um canvas tempor√°rio para preparar a imagem para o envio
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempContext = tempCanvas.getContext('2d');

            // Preenche o fundo do canvas tempor√°rio com branco
            tempContext.fillStyle = '#FFFFFF';
            tempContext.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempContext.drawImage(canvas, 0, 0);                                    // Copia o conte√∫do do canvas principal para o tempor√°rio

            // Converte o canvas para um blob (arquivo de imagem) e o envia para o servidor
            tempCanvas.toBlob((blob) => {
                const formData = new FormData();                                    // Cria um objeto FormData para o envio
                formData.append('file', blob);                                      // Anexa a imagem desenhada
                formData.append('expectedLetter', chosenLetter);                    // Anexa a letra esperada

                fetch('/predict', {                                                 // Faz uma requisi√ß√£o POST para o servidor
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())                              // Converte a resposta para JSON
                    .then(data => {
                        feedbackIcon.innerHTML = data.success
                            ? 'üòä'                                                 // Mostra um √≠cone de carinha feliz se estiver correto
                            : 'üò¢';                                                // Mostra um √≠cone de carinha triste se estiver incorreto
                    })
                    .catch(error => console.error('Erro:', error));                // Mostra um erro no console caso ocorra
            }, 'image/png');
        });

    </script>
</body>

</html>