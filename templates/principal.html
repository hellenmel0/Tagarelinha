<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Tagarelinha: Aprenda brincando com letras e desenhos!">
    <meta name="keywords" content="Educa√ß√£o, Aprendizagem, Letras, Desenho, Tagarelinha">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <title>TAGARELINHA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caprasimo&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap');

        #drawingCanvas {
            cursor: crosshair;
        }


        #currentLetter {
            font-size: 200px;
            margin-bottom: 10px;
            margin-top: 50px;

            font-family: 'Source Code Pro';
            color: #20818C;
        }
    </style>
</head>

<body>
    <!-- Cabe√ßalho da p√°gina com navega√ß√£o -->
    <header>
        <!-- Logo com link para a p√°gina inicial -->
        <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='logo.png') }}" alt="Logo"
                class="logo"></a>
        <nav>
            <!-- Links de navega√ß√£o para diferentes se√ß√µes -->
            <ul>
                <li><a href="{{ url_for('principal') }}">In√≠cio</a></li>
                <li><a href="{{ url_for('fala') }}">Falar √© f√°cil</a></li>
                <li><a href="{{ url_for('letras') }}">Letras</a></li>
            </ul>
        </nav>
        <div class="user-icon">
            <!-- √çcone do perfil do usu√°rio -->
            <a href="{{ url_for('perfil') }}">
                <img src="{{ url_for('static', filename='perfil.png') }}" id="perfil" alt="Usu√°rio">
            </a>
        </div>
    </header>

    <!-- Conte√∫do principal da p√°gina -->
    <main>
        <section class="content">
            <h1>Fa√ßa voc√™ mesmo!</h1>

            <!-- Card principal com o desenho e os controles -->
            <div class="card">
                <div class="box-aluno">
                    <h2>Aluno</h2>
                    <!-- Canvas onde o usu√°rio pode desenhar -->
                    <canvas id="drawingCanvas" width="350" height="300"></canvas><br>
                    <!-- Bot√µes para salvar e apagar o desenho -->
                    <button id="saveButton">Salvar<br><img class="save"
                            src="{{ url_for('static', filename='save.png') }}" alt="Salvar"></button>
                    <button id="clearButton">Apagar<br><img class="clear"
                            src="{{ url_for('static', filename='erase.png') }}" alt="APAGAR"></button>
                </div>


                <!-- Bot√£o para atualizar a letra -->
                <button id="nextButton"><img src="{{ url_for('static', filename='refresh.png') }}"
                        alt="ATUALIZAR LETRA"></button>


                <!-- Box do sistema, aparecer√° a letra escolhida pelo usu√°rio -->
                <div class="box-imagem">
                    <h2>Tagarelinha</h2>
                    <!-- Exibi√ß√£o da letra atual -->
                    <h3 id="currentLetter"></h3>
                    <!-- Bot√£o para ouvir a letra atual -->
                    <button id="listenButton">Ou√ßa<br><img class="listen"
                            src="{{ url_for('static', filename='falante.png') }}" alt="Ouvir"></button>
                </div>
            </div>

            <!-- Bot√£o para enviar o desenho -->
            <button id="predictButton">ENVIAR</button>

            <!-- Div para exibir feedback -->
            <div class="bttns" style="margin-top: 20px;">
                <div class="feedback" id="feedbackIcon"></div>
            </div>
        </section>
    </main>

    <!-- Rodap√© da p√°gina -->
    <footer>
        <p>&copy; Copyright 2024 - Tagarelinha</p>
    </footer>

    <!-- Scripts para a funcionalidade da p√°gina -->
    <script>
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');                // Lista (array) com letras do alfabeto
        let currentprincipal = Math.floor(Math.random() * alphabet.length);     // Gera um √≠ndice aleat√≥rio para selecionar a letra inicial, variando entre 0 e o comprimento do alfabeto
        const visitedLetters = [];                                              // Pilha para armazenar as letras visitadas

        const currentLetterElem = document.getElementById('currentLetter');     // Exibe a letra atual
        const canvas = document.getElementById('drawingCanvas');                // √Årea onde o usu√°rio desenha
        const context = canvas.getContext('2d');                                //Dimens√µes do elemento canvas, para a manipula√ß√£o gr√°fica

        //Refer√™ncias aos bot√µes 'Apagar', 'Enviar', 'Ou√ßa' e ao √≠cone de feedback 
        const clearButton = document.getElementById('clearButton');
        const predictButton = document.getElementById('predictButton');
        const nextButton = document.getElementById('nextButton');               // Bot√£o para trocar a letra
        const feedbackIcon = document.getElementById('feedbackIcon');
        const listenButton = document.getElementById('listenButton');

        // Define vari√°veis e configura√ß√µes de estilo para o desenho no canvas
        let drawing = false;                                                    // Controla se o usu√°rio est√° desenhando
        context.lineWidth = 15;                                                 // Define a espessura da linha do pincel
        context.lineCap = 'round';                                              // Configura o formato das extremidades da linha para serem arredondadas
        context.strokeStyle = '#0B3A40';                                        // Define a cor do tra√ßo de desenho no canvas


        // Fun√ß√£o para limpar todo o conte√∫do do canvas, chamada ao clicar no bot√£o de apagar
        function clearCanvas() {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Fun√ß√£o para reproduzir o som de uma letra usando a s√≠ntese de voz do navegador
        function speakLetter(letter) {
            const synth = window.speechSynthesis;                               // Obt√©m o sintetizador de voz do navegador
            const utterance = new SpeechSynthesisUtterance(letter);             // Cria um objeto de fala para a letra
            utterance.lang = 'pt-BR';                                           // Define o idioma
            synth.speak(utterance);                                             // Reproduz a fala da letra
        }

        // Fun√ß√£o para atualizar a letra exibida na tela com base no √≠ndice `currentprincipal`
        function updateLetter() {
            const letter = alphabet[currentprincipal];                          // Seleciona a letra atual usando o √≠ndice
            currentLetterElem.textContent = letter;                             // Define o conte√∫do de texto do elemento `currentLetterElem` para a letra atual
        }

        // Fun√ß√£o para limpar o feedback de resposta
        function clearFeedback() {
            feedbackIcon.textContent = '';                                      // Limpa feedback
        }

        // Fun√ß√£o para s√≠ntese de fala
        function speakLetter(letter) {
            const synth = window.speechSynthesis;                               // Objeto de s√≠ntese de fala do navegador
            const utterance = new SpeechSynthesisUtterance(letter);             // Cria uma fala com a letra
            utterance.lang = 'pt-BR';                                           // Define o idioma
            synth.speak(utterance);                                             // Executa a fala
        }



        // Adiciona um evento de clique ao bot√£o de ouvir, que fala a letra atual ao ser acionado
        listenButton.addEventListener('click', () => {
            const letter = alphabet[currentprincipal];                          // Pega a letra atual
            speakLetter(letter);                                                // Fala a letra
        });

        // canvas.addEventListener - adiciona eventos para o processo de desenho no canvas
        canvas.addEventListener('mousedown', (event) => {
            drawing = true;                                                     // Marca o in√≠cio do desenho
            context.beginPath();                                                // Inicia um novo caminho de desenho
            const rect = canvas.getBoundingClientRect();                        // Obt√©m a posi√ß√£o do canvas na p√°gina

            // Move a posi√ß√£o inicial do desenho para o ponto onde o usu√°rio clicou
            context.moveTo(event.clientX - rect.left, event.clientY - rect.top);
        });

        canvas.addEventListener('mousemove', (event) => {
            if (drawing) {                                                      // Verifica se o usu√°rio est√° desenhando
                const rect = canvas.getBoundingClientRect();                    // Obt√©m a posi√ß√£o do canvas
                // Cria uma linha at√© o ponto atual do mouse
                context.lineTo(event.clientX - rect.left, event.clientY - rect.top);
                context.stroke();                                               // Desenha a linha no canvas
            }
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;                                                    // Finaliza o desenho ao soltar o bot√£o do mouse
        });

        // Limpa o canvas e o feedback visual ao clicar no bot√£o de apagar
        clearButton.addEventListener('click', () => {
            context.clearRect(0, 0, canvas.width, canvas.height);               // Limpa o canvas
            feedbackIcon.textContent = '';                                      // Limpa o feedback
        });

        // Evento para salvar o desenho como uma imagem PNG ao clicar no bot√£o de salvar
        saveButton.addEventListener('click', () => {
            const link = document.createElement('a');                           // Cria um link para download
            link.download = 'desenho.png';                                      // Define o nome do arquivo a ser baixado
            link.href = canvas.toDataURL('image/png');                          // Obt√©m o conte√∫do do canvas como uma URL de imagem
            link.click();                                                       // Inicia o download da imagem
        });

        // Evento para escolher uma nova letra aleat√≥ria ao clicar no bot√£o para trocar de letra
        nextButton.addEventListener('click', () => {
            let newprincipal;
            // Gera uma nova letra aleat√≥ria, garantindo que n√£o seja igual √† letra atual
            do {
                newprincipal = Math.floor(Math.random() * alphabet.length);
            } while (newprincipal === currentprincipal);
            currentprincipal = newprincipal;                                    // Atualiza o √≠ndice `currentprincipal` para a nova letra
            updateLetter();                                                     // Atualiza a letra exibida na tela
            clearCanvas();                                                      // Limpa o canvas
            clearFeedback();                                                    // Limpa qualquer feedback anterior
        });



        // Evento para enviar o desenho para um servidor ao clicar no bot√£o enviar
        predictButton.addEventListener('click', () => {
            // Cria um canvas tempor√°rio para preparar a imagem com fundo branco
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempContext = tempCanvas.getContext('2d');

            // Preenche o fundo do canvas tempor√°rio com branco, para melhor contraste ao enviar
            tempContext.fillStyle = '#FFFFFF';
            tempContext.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempContext.drawImage(canvas, 0, 0);                                // Copia o conte√∫do do canvas original

            // Converte o canvas tempor√°rio em um blob para enviar a imagem ao servidor
            tempCanvas.toBlob((blob) => {
                const formData = new FormData();                                // Cria um formul√°rio para enviar os dados
                formData.append('file', blob);                                  // Adiciona a imagem como arquivo
                formData.append('expectedLetter', alphabet[currentprincipal]);  // Adiciona a letra esperada

                // Envia a imagem e a letra esperada para a rota '/predict' do servidor
                fetch('/predict', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())                          // Converte a resposta do servidor para JSON
                    .then(data => {
                        feedbackIcon.innerHTML = data.success
                            ? 'üòä'                                             // Carinha feliz para correto
                            : 'üò¢';                                            // Carinha triste para incorreto
                    })
                    .catch(error => console.error('Erro:', error));
            }, 'image/png');
        });

        // Inicializa a letra
        updateLetter();

    </script>
</body>

</html>